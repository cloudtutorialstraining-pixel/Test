package com.zephyrcreation;

import org.json.JSONObject;

import java.util.Iterator;

public class ZephyrCycleService {

    /**
     * Find a Zephyr cycle by name.
     *
     * @param baseUrl   Jira base URL
     * @param auth      Authorization header
     * @param projectId Jira project numeric ID
     * @param versionId Jira version ID (-1 = Unscheduled)
     * @param cycleName Cycle name from GUI
     * @return cycleId if found, otherwise null
     */
    public String findCycle(
            String baseUrl,
            String auth,
            String projectId,
            String versionId,
            String cycleName) {

        UiLogger.log("Searching for Zephyr cycle: " + cycleName);

        String response = JiraRestClient.get(
                baseUrl,
                auth,
                "/rest/zapi/latest/cycle?projectId=" + projectId +
                        "&versionId=" + versionId
        );

        JSONObject cyclesJson = new JSONObject(response);

        Iterator<String> keys = cyclesJson.keys();

        while (keys.hasNext()) {
            String key = keys.next();

            // Skip metadata keys
            if ("recordsCount".equalsIgnoreCase(key)) {
                continue;
            }

            JSONObject cycle = cyclesJson.getJSONObject(key);

            String name = cycle.optString("name", "");

            if (cycleName.equalsIgnoreCase(name)) {
                UiLogger.log("Found existing cycle: " + cycleName +
                        " (ID=" + key + ")");
                return key; // ✅ cycleId
            }
        }

        UiLogger.log("Cycle not found: " + cycleName);
        return null;
    }
}

public void processUpdate(String jql) {

    UiLogger.log("Fetching Jira issues for UPDATE...");

    List<String> issueKeys =
        issueService.fetchIssueKeys(baseUrl, authHeader, jql);

    UiLogger.log("Total Jira stories found: " + issueKeys.size());

    issueKeys.parallelStream().forEach(issueKey -> {
        try {
            UiLogger.log("Updating tests for: " + issueKey);

            String ac =
                issueService.getAcceptanceCriteria(
                    baseUrl, authHeader, issueKey);

            List<ScenarioParser.Scenario> scenarios =
                ScenarioParser.parse(issueKey, ac);

            for (ScenarioParser.Scenario s : scenarios) {

                // ------------------------------------
                // 1️⃣ FIND EXISTING TEST
                // ------------------------------------
                String testKey =
                    zephyrService.findTestCaseKeyByName(
                        baseUrl,
                        authHeader,
                        projectKey,
                        s.name);

                if (testKey == null) {
                    UiLogger.log("[WARN] Test not found, skipping update: " + s.name);
                    continue;
                }

                // ------------------------------------
                // 2️⃣ UPDATE TEST CONTENT
                // ------------------------------------
                zephyrService.updateTestCase(
                    baseUrl,
                    authHeader,
                    issueKey,
                    testKey,
                    String.join("\n", s.steps)
                );

                // ------------------------------------
                // 3️⃣ OPTIONAL: ADD TO CYCLE
                // ------------------------------------
                if (addToCycle) {

                    UiLogger.log("Cycle assignment enabled");

                    // 3.1 Resolve version
                    String versionId;
                    if (releaseName == null || releaseName.isBlank()) {
                        versionId = "-1"; // Unscheduled
                        UiLogger.log("No release provided, using Unscheduled");
                    } else {
                        versionId = issueService.getVersionId(
                            baseUrl,
                            authHeader,
                            projectId,
                            releaseName
                        );
                    }

                    // 3.2 Find or create cycle
                    String cycleId =
                        cycleService.findCycle(
                            baseUrl,
                            authHeader,
                            projectId,
                            versionId,
                            cycleName
                        );

                    if (cycleId == null) {
                        cycleId =
                            cycleService.createCycle(
                                baseUrl,
                                authHeader,
                                projectId,
                                versionId,
                                cycleName
                            );
                    }

                    // 3.3 Add test to cycle (creates execution)
                    cycleService.assignTestToCycle(
                        baseUrl,
                        authHeader,
                        projectId,
                        versionId,
                        cycleId,
                        testKey
                    );

                    UiLogger.log("Test " + testKey + " added to cycle " + cycleName);
                }
            }

            UiLogger.log("Completed update for: " + issueKey);

        } catch (Exception e) {
            UiLogger.log("[ERROR] Update failed for " +
                    issueKey + ": " + e.getMessage());
        }
    });

    AuditReporter.writeCsv();
}
