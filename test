package com.zephyrcreation;

import java.util.*;
import java.util.regex.Pattern;

public class ScenarioParser {

    public static class Scenario {
        public String name;
        public boolean isOutline;
        public List<String> steps = new ArrayList<>();
        public List<String> exampleLines = new ArrayList<>();
    }

    private static final Pattern STEP_PATTERN =
            Pattern.compile("(?i)^(given|when|then|and)\\b.*");

    public static List<Scenario> parse(String storyKey, String text) {

        List<Scenario> scenarios = new ArrayList<>();

        if (text == null || text.trim().isEmpty()) {
            return scenarios;
        }

        Scenario current = null;
        boolean inExamples = false;

        String[] lines = text.split("\\n");

        for (String raw : lines) {

            String line = raw.trim();
            if (line.isEmpty()) continue;

            // -----------------------------
            // SCENARIO / OUTLINE
            // -----------------------------
            if (line.matches("(?i)^scenario( outline)?\\s*:.*")) {

                current = new Scenario();
                current.isOutline = line.toLowerCase().contains("outline");

                String title = line
                        .replaceFirst("(?i)scenario outline", "")
                        .replaceFirst("(?i)scenario", "")
                        .replace(":", "")
                        .trim()
                        .replaceAll("\\s+", "_");

                current.name = storyKey + "_" + title;
                scenarios.add(current);

                inExamples = false;
                continue;
            }

            // -----------------------------
            // STEPS
            // -----------------------------
            if (current != null && STEP_PATTERN.matcher(line).matches()) {
                current.steps.add(line);
                continue;
            }

            // -----------------------------
            // EXAMPLES
            // -----------------------------
            if (current != null && line.equalsIgnoreCase("examples:")) {
                current.isOutline = true;
                inExamples = true;
                continue;
            }

            if (current != null && inExamples && line.startsWith("|")) {
                current.exampleLines.add(line);
            }
        }

        return scenarios;
    }
}